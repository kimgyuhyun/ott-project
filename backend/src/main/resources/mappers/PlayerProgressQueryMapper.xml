<?xml version="1.0" encoding="UTF-8"?> <!-- XML 선언: UTF-8 인코딩 지정 -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> <!-- MyBatis 매퍼 DTD 선언 -->
<mapper namespace="com.ottproject.ottbackend.mybatis.PlayerProgressQueryMapper"> <!-- 매퍼 네임스페이스: 해당 인터페이스와 매핑 -->

	<!-- 결제시각 이후 & 4화 이상(1~3 무료 제외) 누적 시청 초 합 --> <!-- 비즈니스 요약 주석 -->
	<select id="sumWatchedSecondsSincePaidEpisodes" resultType="int"> <!-- 쿼리 ID/반환 타입 정의(int 합계) -->
		select coalesce(sum(ep.position_sec), 0) <!-- 진행 위치(초)의 합계를 구하고 null이면 0 반환 -->
		from episode_progress ep <!-- 시청 진행률 테이블 별칭 ep -->
		join episode e on e.id = ep.episode_id <!-- 에피소드 메타와 조인하여 화수 조건 사용 -->
		where ep.user_id = #{userId} <!-- 대상 사용자 필터 -->
		  and ep.updated_at &gt;= #{since} <!-- 기준 시각(결제 시각) 이후 업데이트된 진행만 합산 -->
		  and e.episode_number &gt;= 4 <!-- 4화 이상(1~3 무료 제외)만 유상 시청으로 간주 -->
	</select> <!-- select 끝 -->

</mapper> <!-- 매퍼 끝 -->


