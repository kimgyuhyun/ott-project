<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
  Mapper: BingeWatchMapper
  - 사용자별 정주행 완료 작품 조회
  - 완결 작품 중 모든 에피소드를 90% 이상 시청한 작품을 정주행으로 간주
-->
<mapper namespace="com.ottproject.ottbackend.mybatis.BingeWatchMapper">

    <!--
      사용자별 정주행 완료 작품 목록 조회
      - 완결 작품(is_completed = true) 중
      - 모든 에피소드를 90% 이상 시청한 작품
      - 정주행 완료 시각 기준 내림차순 정렬
    -->
    <select id="findBingeWatchedAnimes" resultType="com.ottproject.ottbackend.dto.BingeWatchDto">
        <![CDATA[
        SELECT 
            a.id AS aniId,
            COALESCE(a.title, a.title_en, a.title_jp, '제목 없음') AS title,
            a.poster_url AS posterUrl,
            a.total_episodes AS totalEpisodes,
            COUNT(DISTINCT e.id) AS watchedEpisodes,
            MAX(ep.updated_at) AS completedAt
        FROM anime a
        JOIN episodes e ON e.anime_id = a.id
        JOIN episode_progress ep ON ep.episode_id = e.id
        WHERE a.is_completed = true 
            AND ep.user_id = #{userId}
            AND ep.position_sec >= ep.duration_sec * 0.9
            AND ep.duration_sec > 0
        GROUP BY a.id, a.title, a.title_en, a.title_jp, a.poster_url, a.total_episodes
        HAVING COUNT(DISTINCT e.id) = a.total_episodes
        ORDER BY completedAt DESC
        ]]>
    </select>

</mapper>
